<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Device and Status Management</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f7f6;
    color: #333;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

th {
    background-color: #5d8aa8;
    color: white;
}

tr:hover {
    background-color: #e8f4f8;
}

.action-btn {
    cursor: pointer;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    transition: background-color 0.3s;
}

.action-btn.delete {
    background-color: #ffdddd;
}

.action-btn:hover {
    background-color: #d1e2f3;
}

.container {
    padding: 20px;
}

input[type="text"], select {
    margin: 5px 0;
    padding: 8px;
    width: 200px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

button {
    background-color: #4CAF50;
    color: white;
    padding: 10px 15px;
    margin: 5px 0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

button:hover {
    background-color: #45a049;
}


        #assign-modal {
            display: none;
            position: fixed;
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 0px 0px 10px #aaa;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

    .upload-buttons {
        display: inline-block;
        margin-right: 20px;
    }

    .custom-upload-button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    progress {
        width: 100%;
    }


    /* Styling für den "Edit VM Configuration" Button */
    .edit-vm-button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: auto; /* Dieser Stil verschiebt den Button ganz nach rechts */
    }
</style>
</head>
<body>

<div class="container">

    <button onclick="openEditVMModal()" class="custom-button">Edit VM Configuration</button>

<div class="upload-buttons">
    <button onclick="document.getElementById('pogo-apk-file').click()" class="custom-upload-button">Update Pogo</button>
    <input type="file" id="pogo-apk-file" accept=".apk" style="display: none;" onchange="uploadAPK('pogo-apk-file')">
    <progress id="pogo-upload-progress" value="0" max="100" style="display: none;"></progress>
</div>

<div class="upload-buttons">
    <button onclick="document.getElementById('vmapper-apk-file').click()" class="custom-upload-button">Update Vmapper</button>
    <input type="file" id="vmapper-apk-file" accept=".apk" style="display: none;" onchange="uploadAPK('vmapper-apk-file')">
    <progress id="vmapper-upload-progress" value="0" max="100" style="display: none;"></progress>
</div>


    <h1>Status Management</h1>
    <table id="status-table">
        <thead>
            <tr>
                <th>Request MAC</th>
                <th>Status</th>
                <th>Last Check</th>
                <th>Assign</th>
            </tr>
        </thead>
        <tbody>
            <!-- Status rows will go here -->
        </tbody>
    </table>

    <h2>Add Device</h2>
    <input type="text" id="origin" placeholder="Origin">
    <input type="text" id="mac" placeholder="MAC Address">
    <button onclick="addDevice()">Add Device</button>

    <h1>Device Management</h1>
    <table id="device-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Origin</th>
                <th>MAC Address</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Device rows will go here -->
        </tbody>
    </table>

</div>

<div id="assign-modal">
    <h2>Assign Device</h2>
    <select id="origin-select">
        <!-- Origin options will go here -->
    </select>
    <button onclick="submitAssignment()">Assign</button>
</div>

<script>
    window.origins = []; // Global variable for origins
    window.selectedMac = ''; // MAC address of the selected device


function uploadAPK(inputId) {
    var inputFile = document.getElementById(inputId);
    var file = inputFile.files[0];

    if (!file) {
        alert("Please select a file first.");
        return;
    }

    var formData = new FormData();
    formData.append('file', file);

    // Fortschrittsanzeige anzeigen
    var progressId = inputId === 'pogo-apk-file' ? 'pogo-upload-progress' : 'vmapper-upload-progress';
    var progressBar = document.getElementById(progressId);
    progressBar.style.display = 'block';

    $.ajax({
        url: '/upload_apk',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        xhr: function() {
            var xhr = new window.XMLHttpRequest();
            xhr.upload.addEventListener("progress", function(evt) {
                if (evt.lengthComputable) {
                    var percentComplete = evt.loaded / evt.total;
                    progressBar.value = percentComplete * 100;
                }
           }, false);
           return xhr;
        },
        success: function(response) {
            alert("APK uploaded successfully");
            progressBar.style.display = 'none';
            progressBar.value = 0;
        },
        error: function(xhr, status, error) {
            alert("Error uploading APK: " + xhr.responseText);
            progressBar.style.display = 'none';
            progressBar.value = 0;
        }
    });
}
    // Load Status
    function loadStatus() {
        $.ajax({
            url: '/devices/waiting', // URL aktualisiert, um wartende Geräte zu laden
            type: 'GET',
            success: function(response) {
                var rows = "";
                response.waiting_devices.forEach(function(device) {
                    rows += "<tr>" +
                            "<td>" + device.anfrage_mac + "</td>" +
                            "<td>" + device.status + "</td>" +
                            "<td>" + (device.last_check ? device.last_check : 'N/A') + "</td>" +
                            "<td><button class='action-btn assign' onclick='assignDevice(\"" + device.anfrage_mac + "\")'>Assign</button></td>" +
                            "</tr>";
                });
                $("#status-table tbody").html(rows);
            },
            error: function(xhr, status, error) {
                console.error("Error loading status:", xhr.responseText);
            }
        });
    }

    // Load Devices
    function loadDevices() {
        $.ajax({
            url: '/devices/all', // URL zu Ihrer Flask-Route
            type: 'GET',
            success: function(response) {
                var rows = "";
                response.devices.forEach(function(device) {
                    rows += "<tr>" +
                            "<td>" + device.id + "</td>" +
                            "<td>" + device.mac + "</td>" +
                            "<td>" + device.origin + "</td>" +
                            "<td>" +
                                "<button class='action-btn delete' onclick='deleteDevice(" + device.id + ")'>Delete</button>" +
                            "</td>" +
                            "</tr>";
                });
                $("#device-table tbody").html(rows);
                loadOrigins(); // Origins aus Gerätedaten laden
            },
            error: function(xhr, status, error) {
                console.error("Error loading devices:", xhr.responseText);
            }
        });
    }

    // Load Origins für die Zuweisung
    function loadOrigins() {
        $.ajax({
            url: '/devices/all', // Verwenden des vorhandenen Endpunkts
            type: 'GET',
            success: function(response) {
                var uniqueOrigins = new Set();
                response.devices.forEach(function(device) {
                    uniqueOrigins.add(device.origin);
                });
                window.origins = Array.from(uniqueOrigins); // Speichern der einzigartigen Origins
            },
            error: function(xhr, status, error) {
                console.error("Error loading devices for origins:", xhr.responseText);
            }
        });
    }

    // Add Device
    function addDevice() {
        var mac = $('#mac').val();
        var origin = $('#origin').val();
        $.ajax({
            url: '/devices', // URL zu Ihrer Flask POST-Route
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ mac: mac, origin: origin }),
            success: function(response) {
                loadDevices(); // Geräte neu laden
                $('#mac').val('');
                $('#origin').val('');
            },
            error: function(xhr, status, error) {
                alert("Error adding device: " + xhr.responseText);
            }
        });
    }

    // Delete Device
    function deleteDevice(deviceId) {
        if (confirm('Are you sure you want to delete this device?')) {
            $.ajax({
                url: '/devices/' + deviceId, // URL zu Ihrer Flask DELETE-Route
                type: 'DELETE',
                success: function(response) {
                    loadDevices(); // Geräte neu laden
                },
                error: function(xhr, status, error) {
                    alert("Error deleting device: " + xhr.responseText);
                }
            });
        }
    }

    // Open Assignment Modal
    function openAssignModal(mac) {
        window.selectedMac = mac; // Store the MAC address
        var options = "<option value=''>Select Origin</option>";
        window.origins.forEach(function(origin) {
            options += "<option value='" + origin + "'>" + origin + "</option>";
        });
        $('#origin-select').html(options);
        $('#assign-modal').show(); // Show the modal
    }

    // Submit Assignment
    function submitAssignment() {
        var selectedOrigin = $('#origin-select').val();
        if (selectedOrigin) {
            $.ajax({
                url: '/assign/' + window.selectedMac + '/' + selectedOrigin,
                type: 'POST',
                success: function(response) {
                    alert("Device assigned successfully");
                    loadStatus(); // Reload the status
                    $('#assign-modal').hide(); // Hide the modal
                },
                error: function(xhr, status, error) {
                    alert("Error assigning device: " + xhr.responseText);
                }
            });
        } else {
            alert('Please select an origin.');
        }
    }

    // Assign Device using Modal
    function assignDevice(mac) {
        openAssignModal(mac);
    }

    // Initialize
    $(function() {
        loadStatus();
        loadDevices();
    });
</script>

</body>
</html>
